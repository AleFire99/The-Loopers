\chapter{Position Control of the Tip}
\label{cha:position_tip}

    In order to control the position of the tip we tried two different approaches: a frequency based one, like we did for the control of the position of the base, and a full state feedback control scheme.

    \section{Frequency Based Approach}

        Our goal is once again to track a set point for the position of the tip granting a phase margin $\approx$ 60° for robustness. This time we have a trade-off between speed of the controlled system and overshoot of the $\alpha$ angle and we decided to focus more on the latter option.

        \subsection{Controller Design}

            %TODO Insert here Bode of OL uncontrolled scheme, pz map and bode of OL controlled with pz map and explain design

        \subsection{Step Response}

            %TODO Insert here step response and explain features

        \subsection{Frequency Validation}

            %TODO Insert here Bode of CL controlled scheme

    \section{State Space Approach}

    
        \subsection{State Estimators}

            In order to apply a full state feedback control scheme we must be able to know or to estimate the state of our system knowing only its outputs and inputs.

            \subsubsection{State Extractor}

                As our output is the array 
                $\begin{bmatrix}
                    \theta \\
                    \alpha
                \end{bmatrix}$
                and the full state is 
                $\begin{bmatrix}
                    \theta \\
                    \dot\theta \\
                    \alpha \\
                    \dot\alpha 
                \end{bmatrix}$,
                we could just apply a derivative to the output to get the full state, as expressed in the Simulink scheme below.

                \image{./images/Chapter 4/Observers/SE.png}

                The benefits of such observer is that the estimation of the state is instantaneous and there is no dynamics for the error between the real and the estimated state.

                The main drawback is that the derivative is done numerically, so high frequency noises in the measurements could lead to wrong state estimations.
                Luckily the sensors where precise enough so that the noise was not an issue, otherwise we would have introduced a low pass filter to mitigate it.


            \subsubsection{Luenberger Observer}

                In order to provide an estimation for the states we compute an observer that has the goal to imitate the behavior of the system. To get the gain of the observer we impose poles faster \wrt the ones that we will require in the pole placement (2 times):
                \[
                    s = -46; \qquad s = -50; \qquad s=-54; \qquad s=-58;\]

                The Simulink scheme:

                \image{./images/Chapter 4/Observers/StateObserver.png}

                This second possibility implements an estimation of the system  starting from the input and output of itself with a fast enough estimation to keep track of the changes of the system and not to fast to avoid excessive computational load. The drawback comes from the not so high reliability in case of errors.

            \subsubsection{Kalman Filter}

                For this last observer we involve the Kalman Filter Theory that comes from the minimization of the estimated output considering noises in both the states and in the output. 

                For the Variance matrices we choose values small enough because we get a model of the system that we consider correct enough, instead for the output we start from the maximum error of the output due to the digitalization plus a manual tuning we get:

                \begin{equation*}
                    Q = 
                        \begin{bmatrix}
                        10^{-5} & 0 & 0 & 0 \\
                        0 & 10^{-5} & 0 & 0 \\
                        0 & 0 & 10^{-5} & 0 \\
                        0 & 0 & 0 & 10^{-5} 
                    \end{bmatrix} 
                    \qquad 
                    R = 
                    \begin{bmatrix}
                        10^{-8} 
                        \end{bmatrix} 
                \end{equation*} 

                The Simulink Scheme:

                \image{./images/Chapter 4/Observers/KalmanFilter}

        \subsection{Controllers}
            
            \subsubsection{Pole Placement}

                \paragraph{Controller Design}

                \paragraph{Observers Comparison}

                \paragraph{Validation}

                    \subparagraph{Step Response}

                    \subparagraph{Frequency Validation}


            \subsubsection{Linear Quadratic Regulator}

                The LQ regulator is an optimal full state feedback control scheme which has as control law:

                \begin{equation*}
                    u = -K_{LQR}x
                \end{equation*}

                Where $K_{LQR}$ is found by solving this minimization problem:


                $$ \min _{u(\cdot)} \int_0^{t_1}\left(x^T Q x+u^T R u\right) d t $$ 
                subject to $\dot{x}=A x+B u$ 

                Where Q and R are matrices which represent respectively the weight on the state and on the inputs.

                \paragraph{Controller Design}

                    The control scheme is the following:

                    \image{./images/Chapter 4/LQR/Scheme.png}

                    In order to design the LQ controller we choose the matrices Q and R to be diagonal and tweaked their values in order to weight more the state $\alpha$, to make the tip aligned with the base as fast as possible, and the state $\theta$ to grant set point tracking.

                    \begin{equation*}
                    Q = 
                        \begin{bmatrix}
                        Q(1,1) & 0 & 0 & 0 \\
                        0 & 1 & 0 & 0 \\
                        0 & 0 & Q(3,3) & 0 \\
                        0 & 0 & 0 & 1 
                    \end{bmatrix} \,
                    \text{and} \, R = 1
                    \end{equation*} 

                    We tried different values for Q and R and compared the main characteristics of a step response.
                    A summary can be seen in the table below:

                    \begin{table}[h!]
                        \centering
                        \hspace*{-3em}
                        \begin{tabular}{||c c c c c c||} 
                        \hline
                        Q(1,1)  & Q(3,3) & Max overshoot (°) & Settling time (s)& Rising time (s) & Total input (Vs)\\ 
                        \hline\hline
                        1000 & 100 & 14.06 & 0.427 & 0.096 & 3.021 \\ 
                        \hline
                        100 & 1000 & -0.967 & 1.024 & 0.238 & 3.433 \\
                        \hline
                        200 & 1000 & 1.494 & 0.853 & 0.174 & 2.411 \\
                        \hline
                        100 & 2000 & -0.615 & 1.280 & 0.274 & 2.957 \\
                        \hline
                        1000 & 1000 & 9.316 & 0.466 & 0.108 & 3.383 \\ [1ex] 
                        \hline
                        \end{tabular}
                    \end{table}

                    To enhance the performances for the steady state we add an integral action in front of the LQR and evaluate the error:
                    \[
                        \eta = y-y_0\]
                    we impose a convergence rate using in the optimization cost function an exponential function that diverges:
                     \[
                        y =  e^{-15t} \]
                    the value 15 comes from the saturation limit imposed by the actuator of 15 Volts, imposing a faster will break the Circle Criterion.

                    We also use a Kalman Filter for the estimation to have better rejection of the noises \wrt to the State Extractor. 
                    
                    The resultant control is a Linear Quadratic Gaussian Control and its Simulink scheme:

                    \image{./images/Chapter 4/LQR/LQGR.png}



                    %TODO explain chosen parameters

                \paragraph{Observers comparison}

                \paragraph{Validation}

                    \subparagraph{Step Response}
                    \subparagraph{Frequency Validation}